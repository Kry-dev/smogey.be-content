<!DOCTYPE html>
html(lang="en")
    include global/head
    +head('Smogey Calendar')

    include mixin/all-mixin
    body.homepage
        .wrapper
            article.calendar-wrap
                .container.py-3
                    .row.mb-20
                        .col-xs-12
                            nav(aria-label='breadcrumb').bread
                                ol.breadcrumb.mb-0
                                    li.breadcrumb-item
                                        a(href='#') Acceuil
                                    li.breadcrumb-item.active(aria-current='page') Le blog du développement durable
                    .row.mb-20
                        .col-md-12
                            .clearfix.bg-warning.p-2
                                h4.d-inline-block.text-white.float-left L'agenda des initiatives dans votre commune
                                a.d-inline-block.btn.btn-outline-warning.float-right(role="button", href="index.html")
                                    span Retour
                    .row.mb-20
                        .col-xs-12
                            #calendar-01.calendar-second
                            #popoverContent.hide
                                .row.p-3.p-sm-2
                                    .col-sm-9.col-xs-12.mb-sm-3
                                        p
                                            | 71, rue de Tolbiac,
                                            br
                                            |  PARIS 75013,
                                            br
                                            |  Magasin vrac
                                        button.btn.btn-success.w-100.text-center(type='button', data-toggle='modal',data-target='#mapMarkerModal')
                                            |  More information
                                    .col-sm-3.col-xs-12
                                        img.img-responsive.m-auto(src='assets/img/calendar/pin-01.png')
                    .row.mx-0.mb-20
                        a.btn.btn-pink(href='#plus-initiative', data-toggle='modal')
                            i.fa.fa-plus-circle
                            span Poposer un événement

        //// Modal
        #mapMarkerModal.modal.fade(tabindex='-1', role='dialog', aria-labelledby='mapMarkerModalTitle', aria-hidden='true')
            .modal-dialog(role='document')
                .modal-content
                    .modal-header.bg-pink.text-white
                        h4.modal-title Naturalia Tolbiac
                        button.btn-close(type='button', data-dismiss='modal', aria-label='Close')
                            span.fa.fa-close.text-white(aria-hidden='true')
                    .modal-body
                        .row.mb-20
                            .col-sm-6.mb-3
                                img.w-100(src='assets/img/map/map-modal-01.jpg')
                            .col-sm-6.mb-3
                                #map-canvas(style='width: 100%; height: 200px;')

                        p.mb-0
                            | Depuis quelques jours, la Ville de Tournai constate que des sacs poubelles d’ordures ménagères apparaissent à différents endroits de l’entité à des jours inappropriés alors que le calendrier de ramassage de ces poubelles.
                    .modal-footer.border-0.justify-content-start
                        button.btn.btn-primary(type='button') En savoir plus
        // Modal
        #plus-initiative.modal.fade(tabindex='-1', role='dialog', aria-labelledby='plus-initiativeTitle', aria-hidden='true')
            .modal-dialog(role='document')
                form.modal-content.plus-init-form
                    .modal-header.bg-pink.text-white
                        h4.modal-title Ajouter une initiative
                        button.btn-close(type='button', data-dismiss='modal', aria-label='Close')
                            span.fa.fa-close.text-white(aria-hidden='true')
                    .modal-body
                        .form-group
                            i.fa.fa-user
                            input.form-control(id="init-title", type='text', placeholder='Titre')
                        .form-group
                            i.fa.fa-pencil-square-o
                            input.form-control(id="init-descr", type='text', placeholder='Detail')
                        .form-group
                            i.fa.fa-list-alt
                            input.form-control(id="datetimepicker4", type='text', placeholder='Engagements citoyens ')
                        .form-group
                            i.fa.fa-map-marker
                            input.form-control(id="pac-input", type='text', name='keyword' placeholder='Localisation')
                            button.btn.btn-warning.text-white
                                i.fa.fa-location-arrow
                                | Localiser

                    .modal-footer.border-0.justify-content-center
                        button.btn.btn-pink Ajouter

        script(src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.js")
        script.
            $(function () {
                $('#datetimepicker4').datetimepicker({format: 'YYYY-MM-DD'});
            });
            var popTemplate = [
                '<div class="popover" style="max-width:600px;" >',
                '<div class="arrow"></div>',
                '<div class="popover-header bg-pink text-white p-1">',
                '<button id="closepopover" type="button" class="close" aria-hidden="true">&times;</button>',
                '<h3 class="popover-title"></h3>',
                '</div>',
                '<div class="popover-content">',
                '</div>',
                '</div>'].join('');

            var date = new Date();
            var d = date.getDate();
            var m = date.getMonth();
            var y = date.getFullYear();
            var blue =  "#00bfe3";
            var indigo =  "#6610f2";
            var pink   =  "#d92988";
            var pinkdark =  "#a90c45";
            var red    =  "#B50E0B";
            var orange =  "#fd7e14";
            var yellow =  "#fdb32a";
            var green =  "#96B314";
            var teal =  "#16a085";
            var cyan   =  "#17a2b8";
            var gray =  "#f4f3f3";
            var dark =  "#2a2a2f";

            $('#calendar-01').fullCalendar({
                header: {
                    left: 'prev',
                    center: 'title',
                    right: 'next'
                },
                defaultView: 'month',
                displayEventTime: false,
                eventLimit: true,
                events: [
                {
                    title: 'Naturalia Tolbiac -1',
                    start: new Date(y, m, d + 4, 16, 0),
                    color: pink,
                    placement: 'bottom',
                    text: "71, rue de Tolbiac,' + <br> + 'PARIS 75013,' + <br> + ' Magasin vrac",

                }, {
                    title: 'Naturalia Tolbiac -2',
                    start: new Date(y, m, d, 10, 30),
                    color: blue
                },{
                    title: 'Naturalia Tolbiac -2',
                    start: new Date(y, m, d, 10, 30),
                    color: blue
                }, {
                    title: 'Naturalia Tolbiac -10',
                    start: new Date(y, m, d, 12, 0),
                    color: red
                }, {
                    title: 'Naturalia Tolbiac -11',
                    start: new Date(y, m, d, 12, 0),
                    color: pinkdark
                }, {
                    title: 'Naturalia Tolbiac -4',
                    start: new Date(y, m, d + 1, 19, 0),
                    color: green
                }, {
                    title: 'Naturalia Tolbiac -4',
                    start: new Date(y, m, d - 1, 1, 0),
                    color: green
                }

                ],

                select: function (start, end, jsEvent) {
                    closePopovers();
                    popoverElement = $(jsEvent.target);
                    $(jsEvent.target).popover({
                        title: 'the title',
                        content: function () {
                            return $("#popoverContent").html();
                        },
                        template: popTemplate,
                        html: 'true',
                        trigger: 'click',
                        animation: 'true',
                        container: 'body'

                    }).popover('show');
                },

                eventClick: function (calEvent, jsEvent, view) {
                    //closePopovers();
                    popoverElement = $(jsEvent.currentTarget);
                },

                eventRender: function (event, element) {
                    element.popover({
                        title: event.title,
                        content: function () {
                            return $("#popoverContent").html();
                        },
                        template: popTemplate,
                        //placement: 'auto',
                        placement: function (tip, element) {
                            var $element, above, actualHeight, actualWidth, below, boundBottom, boundLeft, boundRight, boundTop, elementAbove, elementBelow, elementLeft, elementRight, isWithinBounds, left, pos, right;
                            isWithinBounds = function (elementPosition) {
                                return boundTop < elementPosition.top && boundLeft < elementPosition.left && boundRight > (elementPosition.left + actualWidth) && boundBottom > (elementPosition.top + actualHeight);
                            };

                            $element = $(element);
                            pos = $.extend({}, $element.offset(), {
                                width: element.offsetWidth,
                                height: element.offsetHeight
                            });
                            actualWidth = 230;
                            actualHeight = 280;
                            boundTop = $(document).scrollTop();
                            boundLeft = $(document).scrollLeft();
                            boundRight = boundLeft + $(window).width();
                            boundBottom = boundTop + $(window).height();
                            elementAbove = {
                                top: pos.top - actualHeight,
                                left: pos.left + pos.width / 2 - actualWidth / 2
                            };
                            elementBelow = {
                                top: pos.top + pos.height,
                                left: pos.left + pos.width / 2 - actualWidth / 2
                            };
                            elementLeft = {
                                top: pos.top + pos.height / 2 - actualHeight / 2,
                                left: pos.left - actualWidth
                            };
                            elementRight = {
                                top: pos.top + pos.height / 2 - actualHeight / 2,
                                left: pos.left + pos.width
                            };
                            above = isWithinBounds(elementAbove);
                            below = isWithinBounds(elementBelow);
                            left = isWithinBounds(elementLeft);
                            right = isWithinBounds(elementRight);


                            if (left) {
                                return "left";
                            } else {
                                if (below) {
                                    return "bottom";
                                } else {
                                    if (above) {
                                        return "top";
                                    } else {
                                        if (right) {
                                            return "right";
                                        } else {
                                            return "right";
                                        }
                                    }
                                }
                            }
                        },
                        html: 'true',
                        trigger: 'click',
                        animation: 'true',
                        container: '#calendar-01'
                    });

                },
                //eventAfterAllRender: function () {
                  //  $('.fc-row.fc-week.fc-widget-content').attr('style', 'height: auto ');
                //}

            });


            var popoverElement;

            function closePopovers() {
                $('.popover').not(this).popover('hide');
            }
            if($('.modal[aria-hidden="true"]')){
                closePopovers();
            }

            $('body').on('click', function (e) {
                // close the popover if: click outside of the popover || click on the close button of the popover
                if (popoverElement && ((!popoverElement.is(e.target) && popoverElement.has(e.target).length === 0 && $('.popover').has(e.target).length === 0) || (popoverElement.has(e.target) && e.target.id === 'closepopover'))) {

                    ///$('.popover').popover('hide'); --> works
                    closePopovers();
                }
            });






